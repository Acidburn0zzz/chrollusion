<!--
  A background page that aggregates tracking requests.

  Copyright 2012 Disconnect, Inc.

  This program is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License as published by the Free Software
  Foundation, either version 3 of the License, or (at your option) any later
  version.

  This program is distributed in the hope that it will be useful, but WITHOUT
  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
  FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

  You should have received a copy of the GNU General Public License along with
  this program. If not, see <http://www.gnu.org/licenses/>.

  Authors (one per line):

    Brian Kennish <byoogle@gmail.com>
    Jeremy Singer-Vine <jsvine@gmail.com>
-->
<script src="../scripts/vendor/port.js"></script>
<script src="../scripts/vendor/jquery.min.js"></script>
<script>
  /* Destringifies an object. */
  function deserialize(object) {
    return typeof object == 'string' ? JSON.parse(object) : object;
  }

  /* Picks a random animation path. */
  function getScene() {
    return scenes.splice(Math.floor(Math.random() * scenes.length), 1)[0];
  }

  /* Constants. */
  var extension = chrome.extension;
  var browserAction = chrome.browserAction;
  var setIcon = browserAction.setIcon;
  var tlds = deserialize(localStorage.tlds) || {
    'com.ar': true,
    'edu.ar': true,
    'gob.ar': true,
    'gov.ar': true,
    'int.ar': true,
    'mil.ar': true,
    'net.ar': true,
    'org.ar': true,
    'tur.ar': true,
    'ac.bd': true,
    'com.bd': true,
    'edu.bd': true,
    'gov.bd': true,
    'mil.bd': true,
    'net.bd': true,
    'org.bd': true,
    'com.bn': true,
    'edu.bn': true,
    'gov.bn': true,
    'net.bn': true,
    'org.bn': true,
    'biz.ck': true,
    'co.ck': true,
    'edu.ck': true,
    'gen.ck': true,
    'gov.ck': true,
    'info.ck': true,
    'net.ck': true,
    'org.ck': true,
    'ac.cy': true,
    'biz.cy': true,
    'com.cy': true,
    'ekloges.cy': true,
    'gov.cy': true,
    'ltd.cy': true,
    'name.cy': true,
    'net.cy': true,
    'org.cy': true,
    'parliament.cy': true,
    'press.cy': true,
    'pro.cy': true,
    'tm.cy': true,
    'com.er': true,
    'edu.er': true,
    'gov.er': true,
    'ind.er': true,
    'mil.er': true,
    'net.er': true,
    'org.er': true,
    'biz.et': true,
    'com.et': true,
    'edu.et': true,
    'gov.et': true,
    'info.et': true,
    'name.et': true,
    'net.et': true,
    'org.et': true,
    'ac.fj': true,
    'biz.fj': true,
    'com.fj': true,
    'info.fj': true,
    'mil.fj': true,
    'name.fj': true,
    'net.fj': true,
    'org.fj': true,
    'pro.fj': true,
    'ac.fk': true,
    'co.fk': true,
    'gov.fk': true,
    'net.fk': true,
    'nom.fk': true,
    'org.fk': true,
    'com.gt': true,
    'edu.gt': true,
    'gob.gt': true,
    'ind.gt': true,
    'mil.gt': true,
    'net.gt': true,
    'org.gt': true,
    'com.gu': true,
    'edu.gu': true,
    'gov.gu': true,
    'net.gu': true,
    'org.gu': true,
    'ac.il': true,
    'co.il': true,
    'gov.il': true,
    'idf.il': true,
    'k12.il': true,
    'muni.il': true,
    'net.il': true,
    'org.il': true,
    'com.jm': true,
    'edu.jm': true,
    'gov.jm': true,
    'mil.jm': true,
    'net.jm': true,
    'org.jm': true,
    'ac.ke': true,
    'co.ke': true,
    'go.ke': true,
    'info.ke': true,
    'me.ke': true,
    'mobi.ke': true,
    'ne.ke': true,
    'or.ke': true,
    'sc.ke': true,
    'com.kh': true,
    'edu.kh': true,
    'gov.kh': true,
    'mil.kh': true,
    'net.kh': true,
    'org.kh': true,
    'per.kh': true,
    'com.kw': true,
    'edu.kw': true,
    'gov.kw': true,
    'net.kw': true,
    'org.kw': true,
    'com.mm': true,
    'edu.mm': true,
    'gov.mm': true,
    'net.mm': true,
    'org.mm': true,
    'com.mt': true,
    'edu.mt': true,
    'gov.mt': true,
    'net.mt': true,
    'org.mt': true,
    'ac.mz': true,
    'adv.mz': true,
    'co.mz': true,
    'edu.mz': true,
    'gov.mz': true,
    'org.mz': true,
    'ac.ni': true,
    'co.ni': true,
    'gob.ni': true,
    'mil.ni': true,
    'net.ni': true,
    'nom.ni': true,
    'org.ni': true,
    'com.np': true,
    'edu.np': true,
    'gov.np': true,
    'mil.np': true,
    'name.np': true,
    'net.np': true,
    'org.np': true,
    'ac.nz': true,
    'co.nz': true,
    'cri.nz': true,
    'geek.nz': true,
    'gen.nz': true,
    'govt.nz': true,
    'health.nz': true,
    'iwi.nz': true,
    'maori.nz': true,
    'mil.nz': true,
    'net.nz': true,
    'org.nz': true,
    'parliament.nz': true,
    'school.nz': true,
    'ac.om': true,
    'biz.om': true,
    'co.om': true,
    'com.om': true,
    'edu.om': true,
    'gov.om': true,
    'med.om': true,
    'mil.om': true,
    'museum.om': true,
    'net.om': true,
    'org.om': true,
    'pro.om': true,
    'sch.om': true,
    'ac.pg': true,
    'com.pg': true,
    'gov.pg': true,
    'mil.pg': true,
    'net.pg': true,
    'org.pg': true,
    'com.py': true,
    'coop.py': true,
    'edu.py': true,
    'gov.py': true,
    'mil.py': true,
    'net.py': true,
    'org.py': true,
    'com.sv': true,
    'edu.sv': true,
    'gob.sv': true,
    'org.sv': true,
    'red.sv': true,
    'av.tr': true,
    'bbs.tr': true,
    'bel.tr': true,
    'biz.tr': true,
    'com.tr': true,
    'dr.tr': true,
    'edu.tr': true,
    'gen.tr': true,
    'gov.tr': true,
    'info.tr': true,
    'k12.tr': true,
    'name.tr': true,
    'nc.tr': true,
    'net.tr': true,
    'org.tr': true,
    'pol.tr': true,
    'tel.tr': true,
    'tsk.tr': true,
    'tv.tr': true,
    'web.tr': true,
    'ac.uk': true,
    'bl.uk': true,
    'british-library.uk': true,
    'co.uk': true,
    'gov.uk': true,
    'jet.uk': true,
    'judiciary.uk': true,
    'ltd.uk': true,
    'me.uk': true,
    'mod.uk': true,
    'net.uk': true,
    'nhs.uk': true,
    'nic.uk': true,
    'nls.uk': true,
    'org.uk': true,
    'parliament.uk': true,
    'plc.uk': true,
    'police.uk': true,
    'sch.uk': true,
    'com.uy': true,
    'edu.uy': true,
    'gub.uy': true,
    'mil.uy': true,
    'net.uy': true,
    'org.uy': true,
    'co.ve': true,
    'com.ve': true,
    'edu.ve': true,
    'gob.ve': true,
    'info.ve': true,
    'mil.ve': true,
    'net.ve': true,
    'org.ve': true,
    'tec.ve': true,
    'web.ve': true,
    'co.ye': true,
    'com.ye': true,
    'gov.ye': true,
    'ltd.ye': true,
    'me.ye': true,
    'net.ye': true,
    'org.ye': true,
    'plc.ye': true,
    'ac.za': true,
    'agric.za': true,
    'city.za': true,
    'co.za': true,
    'cybernet.za': true,
    'edu.za': true,
    'gov.za': true,
    'grondar.za': true,
    'iaccess.za': true,
    'inca.za': true,
    'law.za': true,
    'mil.za': true,
    'nis.za': true,
    'nom.za': true,
    'olivetti.za': true,
    'org.za': true,
    'pix.za': true,
    'school.za': true,
    'ecape.school.za': true,
    'fs.school.za': true,
    'gp.school.za': true,
    'kzn.school.za': true,
    'lp.school.za': true,
    'mpm.za': true,
    'ncape.school.za': true,
    'nw.school.za': true,
    'wcape.school.za': true,
    'ac.zm': true,
    'co.zm': true,
    'com.zm': true,
    'edu.zm': true,
    'gov.zm': true,
    'net.zm': true,
    'org.zm': true,
    'sch.zm': true,
    'ac.zw': true,
    'co.zw': true,
    'org.zw': true
  };
  var tabs = {};
  var log = {};
  var startTime = new Date();
  var scenes = [1, 2, 3, 4, 5];
  var currentScene = getScene();
  var frameCount = 7;
  var frameLength = 100;
  var fileExtension = '.png';

  parseInt(localStorage.sidebarCollapsed, 10) &&
      localStorage.sidebarCollapsed--; // An experimental "semisticky" bit.

  $.get(
    'https://mxr.mozilla.org/mozilla-central/source/netwerk/dns/effective_tld_names.dat?raw=1',
    function(data) {
      data = data.split('\n');
      var lineCount = data.length;

      for (var i = 0; i < lineCount; i++) {
        var line = $.trim(data[i]);

        if (line && line.slice(0, 2) != '//') {
          var prefix = line.charAt(0);

          // Fancy syntax is fancy.
          if (prefix == '*' || prefix == '!') line = line.slice(1);
          if (line.charAt(0) == '.') line = line.slice(1);

          tlds[line] = true;
        }
      }

      localStorage.tlds = JSON.stringify(tlds);
    }
  );

  setIcon({
    path:
        (SAFARI ? 'chrome' : '') + '/images/' + currentScene + '/1' +
            fileExtension
  });

  /* Restricts the toolbar animation to 1x per load of the topmost window. */
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
    changeInfo.status == 'loading' && delete tabs[tabId];
  });

  /* Refreshes the data and graph if open. */
  extension.onRequest.addListener(function(request, sender, sendResponse) {
    var tab = sender.tab;

    if (request.initialized) sendResponse({tlds: tlds, referrerUrl: tab.url});
    else {
      // The Collusion data structure.
      var domain = request.domain;
      var domainName = domain.name;
      if (!(domainName in log))
          log[domainName] = {
            host: domain.host,
            referrers: {},
            visited: false
          };

      var referrerDomain = request.referrerDomain;
      var referrerName = referrerDomain.name;
      var referrerHost = referrerDomain.host;
      if (!(referrerName in log))
          log[referrerName] = {
            host: referrerHost,
            referrers: {}
          };
      log[referrerName].visited = true;

      var referrers = log[domainName].referrers;
      if (!(referrerName in referrers))
          referrers[referrerName] = {
            host: referrerHost,
            types: [new Date() - startTime]
          };

      var types = referrers[referrerName].types;
      var type = request.type;
      types.indexOf(type) == -1 && types.push(type);

      // A live update.
      var popup = extension.getViews({type: 'popup'})[0];
      popup && popup.graph && popup.graph.update(log);

      // Animation.
      var tabId = tab.id;

      if (!(tabId in tabs) && request.animate) {
        tabs[tabId] = {};
        for (var i = 0; i < frameCount - 1; i++)
            setTimeout(function(scene, index) {
              setIcon({
                path:
                    (SAFARI ? 'chrome' : '') + '/images/' + scene + '/' +
                        (index + 2) + fileExtension
              });
            }, i * frameLength, currentScene, i);
        var previousScene = currentScene;
        currentScene = getScene();
        scenes.push(previousScene);
        for (var i = 0; i < frameCount; i++)
            setTimeout(function(scene, index) {
              setIcon({
                path:
                    (SAFARI ? 'chrome' : '') + '/images/' + scene + '/' +
                        (frameCount - index) + fileExtension
              });
            }, (i + frameCount - 1) * frameLength, currentScene, i);
      }

      var domainNames = tabs[tabId];
      domainNames[domainName] = ++domainNames[domainName] || 1;
          // A count, for future use.
      deserialize(localStorage.badgeShown) &&
          browserAction.setBadgeText({
            text: Object.keys(domainNames).length + '', tabId: tabId
          });

      // Cleanup.
      sendResponse({});
    }
  });
</script>
