<!--
  A background page that aggregates tracking requests.

  Copyright 2012 Disconnect, Inc.

  This program is free software: you can redistribute it and/or modify it under
  the terms of the GNU General Public License as published by the Free Software
  Foundation, either version 3 of the License, or (at your option) any later
  version.

  This program is distributed in the hope that it will be useful, but WITHOUT
  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
  FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

  You should have received a copy of the GNU General Public License along with
  this program. If not, see <http://www.gnu.org/licenses/>.

  Authors (one per line):

    Brian Kennish <byoogle@gmail.com>
-->
<script src="js/vendor/port.js"></script>
<script>
  /* Picks a random animation path. */
  function getScene() {
    return scenes.splice(Math.floor(Math.random() * scenes.length), 1)[0];
  }

  /* Constants. */
  var extension = chrome.extension;
  var setIcon = chrome.browserAction.setIcon;
  var should_show_badge = localStorage.getItem("should_show_badge") !== "0";
  var setBadgeText = should_show_badge && chrome && chrome.browserAction && chrome.browserAction.setBadgeText;
  var setBadgeBackgroundColor = should_show_badge && chrome && chrome.browserAction && chrome.browserAction.setBadgeBackgroundColor;
  var tabs = {};
  var log = {};
  var startTime = new Date();
  var scenes = [1, 2, 3, 4, 5];
  var currentScene = getScene();
  var frameCount = 7;
  var frameLength = 100;
  var fileExtension = '.png';
  var lastURL = '';

  // Initialize the tracker counter for a given tab, with arrays to be filled
  // with all 3rd party domains, and a subset of those that are confirmed trackers.
  var initializeCounter = function (tabId) {
	  tabs[tabId] = { all: [], confirmed_trackers: [], animated: false };
  };

  parseInt(localStorage.sidebarCollapsed, 10) &&
      localStorage.sidebarCollapsed--; // An experimental "semisticky" bit.
  setIcon({path: 'images/' + currentScene + '/1' + fileExtension});

  // Listen for tab changes.
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
	var hashPattern = /#.*$/;
	// If the change is that the page has started loading...
    changeInfo.status == 'loading' 
		// ... and the new page isn't just the same URL with a different hash value ...
		&& (lastURL.replace(hashPattern, "") !== tab.url.replace(hashPattern, "") || lastURL === tab.url)
		// ... then reset the current tab's counter.
		&& initializeCounter(tabId);
	// Set lastURL to current URL.
	lastURL = tab.url;
  });

  /* Refreshes the data and graph if open. */
  extension.onRequest.addListener(function(request, sender, sendResponse) {
    var tab = sender.tab;
    var tabId = tab.id;
	if (!tabs[tabId]) initializeCounter(tabId);
    if (request.initialized) {
		sendResponse({referrerUrl: tab.url});
	}
    else {

      // The Collusion data structure.
      var domain = request.domain;
      var domainName = domain.name;
      if ( domainName == null )
        smartTLD( 'domainName', domain.host );

      var referrerDomain = request.referrerDomain;
      var referrerName = referrerDomain.name;
      if ( referrerName == null )
        smartTLD( 'referrerName', referrerDomain.host );
      var referrerHost = referrerDomain.host;


      // Given a varname and hostname, intelligently makes use of what's already in the browser in terms of the public suffix list,
      // and the code to handle that to get at the effective TLD of the hostname! Assign found TLD to the varname
      function smartTLD( varname, hostname ) {

        var labels = hostname.split('.');
        var walk = labels.pop();
        walk = labels.pop() + '.' + walk;

        walktest();

        function walktest() {
          chrome.cookies.set(
            { url: 'http://' + hostname, domain: walk, name: 'chrollusion__jf_walktest__01189998819991197253', value: 'test' },
            function( succ ) {
              if ( succ != null ) {	// !!--> WTH!!!! http://code.google.com/chrome/extensions/cookies.html#method-set is Wrong (or at best misleading?)?!!
                eval( varname + ' = "' + succ.domain.slice(1) + '"' );
                if ( referrerName && domainName )
                  carryOn();
              }
              else {	// !! future-proofing when the documentation actually becomes correct?
                walk = labels.pop() + '.' + walk;
                walktest();
              }
            }
          );
        }

      }


      function carryOn() {
        //name && name != extensionId && name != referrerName &&
        if ( domainName == referrerName ) {
          sendResponse({});
          return;
        }

        if (!(domainName in log))
            log[domainName] = {
              host: domain.host,
              referrers: {},
              visited: false
            };

        if (!(referrerName in log))
            log[referrerName] = {
              host: referrerHost,
              referrers: {}
            };
        log[referrerName].visited = true;

        var referrers = log[domainName].referrers;
        if (!(referrerName in referrers))
            referrers[referrerName] = {
              host: referrerHost,
              types: [new Date() - startTime]
            };
   
        var types = referrers[referrerName].types;
        var type = request.type;
        types.indexOf(type) == -1 && types.push(type);
   
        // A live update.
        var popup = extension.getViews({type: 'popup'})[0];
        popup && popup.graph && popup.graph.update(log);
   
        // Animate if icon hasn't animated yet while on this URL.
        if (!(tabId in tabs) && request.animate && localStorage.getItem("should_show_animation") != "0") {
          tabs[tabId] = true;
          for (var i = 0; i < frameCount - 1; i++)
              setTimeout(function(scene, index) {
                setIcon({path: 'images/' + scene + '/' + (index + 2) + fileExtension});
              }, i * frameLength, currentScene, i);
          var previousScene = currentScene;
          currentScene = getScene();
          scenes.push(previousScene);
          for (var i = 0; i < frameCount; i++)
              setTimeout(function(scene, index) {
                setIcon({
                  path: 'images/' + scene + '/' + (frameCount - index) + fileExtension
                });
              }, (i + frameCount - 1) * frameLength, currentScene, i);
        }
   
        // If we haven't seen this 3rd-party domain here yet...
        if (tabs[tabId].all.indexOf(domainName) === -1) {
        	// Mark this 3rd-party domain as seen.
      	tabs[tabId].all.push(domainName);
      	// Update the icon badge.
      	setBadgeBackgroundColor && setBadgeBackgroundColor({ color: [ 255, 0, 0, 255 ], tabId: tabId });
      	setBadgeText && setBadgeText({ text: String(tabs[tabId].all.length), tabId: tabId });
        }
   
        // Cleanup.
        sendResponse({});
      }

    }
  });
</script>
